{
    auto_https off
    admin off

    log {
        output file /var/log/caddy/caddy.log
        format json
        level INFO
    }
}

# Misskey service
mi.ruruke.moe:80 {
    reverse_proxy http://100.103.133.21:3000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up Upgrade {>Upgrade}
        header_up Connection {>Connection}
    }
    
    request_body {
        max_size 100MB
    }
    
    log {
        output file /var/log/caddy/misskey_access.log
        format json
    }
}

# Media proxy service
media.ruruke.moe:80 {
    reverse_proxy http://100.97.11.65:12766 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    log {
        output file /var/log/caddy/media_proxy_access.log
        format json
    }
}

# Storage service (S3 proxy)
storage.ruruke.moe:80 {
    reverse_proxy https://s3.ap-northeast-2-ntt.wasabisys.com/storage.ruruke.moe/ {
        header_up Host s3.us-east-2.wasabisys.com
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-Proto https
        header_up Proxy ""
        header_down Cache-Control "public, max-age=2592000"
        header_down Pragma "public"
    }
    
    request_body {
        max_size 1000MB
    }
    
    encode gzip
    
    log {
        output file /var/log/caddy/storage_access.log
        format json
    }
}

# Summaly service
summaly.ruruke.moe:80 {
    reverse_proxy http://100.114.43.64:3030 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    log {
        output file /var/log/caddy/summaly_access.log
        format json
    }
}

# Homepage
ruru.my:80 {
    reverse_proxy http://100.114.43.64:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    log {
        output file /var/log/caddy/homepage_access.log
        format json
    }
}
