{
    auto_https off
    admin off

}

# Default routing (to anubis)
:80 {
    @media host media.ruruke.moe
    @summaly host summaly.ruruke.moe  
    @storage host storage.ruruke.moe
    
    # Direct routes (bypass anubis)
    handle @media {
        reverse_proxy http://proxy-2:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    handle @summaly {
        reverse_proxy http://proxy-2:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    handle @storage {
        reverse_proxy http://proxy-2:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
    
    # Default route to anubis
    handle {
        reverse_proxy http://anubis:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}

# Misskey special routing
mi.ruruke.moe:80 {
    # Bypass anubis for specific paths
    @bypass path /streaming* /inbox* /outbox* /api* /.well-known*
    
    handle @bypass {
        reverse_proxy http://proxy-2:80 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up Upgrade {>Upgrade}
            header_up Connection {>Connection}
        }
    }
    
    # Default route to anubis
    handle {
        reverse_proxy http://anubis:8080 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
        }
    }
}
