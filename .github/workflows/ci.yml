name: Cerberus CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Linting and code quality
  lint:
    name: Lint and Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup shell linting
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          find . -name "*.sh" -not -path "./tests/tmp/*" -not -path "./built/*" | xargs shellcheck -e SC1091,SC2034,SC2154

      - name: Check TOML syntax
        uses: tamasfe/taplo@0.8.1
        with:
          command: check
          file-patterns: "**/*.toml"

  # Unit and integration tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        test-suite:
          - unit
          - integration-simple
          - integration-all
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc netcat-openbsd

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Clean test environment
        run: |
          rm -rf tests/tmp/*
          rm -rf built/*

      - name: Make test scripts executable
        run: |
          find tests/ -name "*.sh" -exec chmod +x {} \;
          chmod +x cerberus.sh

      - name: Run unit tests
        if: matrix.test-suite == 'unit'
        run: |
          for test in tests/test-*-generator.sh tests/test-simple-config.sh; do
            if [[ -f "$test" ]]; then
              echo "Running $test..."
              "$test"
            fi
          done

      - name: Run simple integration tests
        if: matrix.test-suite == 'integration-simple'
        run: |
          ./tests/test-integration-simple.sh

      - name: Run minimal tests (fallback)
        if: matrix.test-suite == 'integration-all'
        timeout-minutes: 5
        run: |
          ./tests/test-minimal.sh

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            tests/tmp/
            built/
          retention-days: 7

  # Multi-run stability test
  stability:
    name: Stability Test (10 runs)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc

      - name: Make test scripts executable
        run: |
          find tests/ -name "*.sh" -exec chmod +x {} \;
          chmod +x cerberus.sh

      - name: Run stability test
        run: |
          success_count=0
          total_runs=10
          
          for i in $(seq 1 $total_runs); do
            echo "=== Stability Test Run $i/$total_runs ==="
            rm -rf tests/tmp/* built/* || true
            
            if timeout 30 ./tests/test-minimal.sh; then
              echo "‚úÖ Run $i: PASSED"
              ((success_count++))
            else
              echo "‚ùå Run $i: FAILED"
            fi
            
            # Clean between runs
            rm -rf tests/tmp/* built/* || true
            sleep 1
          done
          
          echo "=== Stability Test Results ==="
          echo "Successful runs: $success_count/$total_runs"
          echo "Success rate: $(( success_count * 100 / total_runs ))%"
          
          if [ $success_count -eq $total_runs ]; then
            echo "üéâ All runs passed!"
            exit 0
          elif [ $success_count -ge 8 ]; then
            echo "‚ö†Ô∏è Most runs passed (acceptable)"
            exit 0
          else
            echo "‚ùå Too many failures"
            exit 1
          fi

  # Docker build test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate test configuration
        run: |
          mkdir -p built
          cp config-example.toml test-config.toml
          ./cerberus.sh generate --config test-config.toml --output built

      - name: Test Docker Compose syntax
        run: |
          if [ -f built/docker-compose.yaml ]; then
            docker-compose -f built/docker-compose.yaml config
          else
            echo "No docker-compose.yaml generated"
            exit 1
          fi

      # - name: Build Docker images
      #   run: |
      #     if [ -d built/dockerfiles ]; then
      #       for dockerfile_dir in built/dockerfiles/*/; do
      #         if [ -f "$dockerfile_dir/Dockerfile" ]; then
      #           service_name=$(basename "$dockerfile_dir")
      #           echo "Building $service_name..."
      #           docker build -t "cerberus-test-$service_name" "$dockerfile_dir"
      #         fi
      #       done
      #     fi

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Release preparation
  release:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: [test, stability, docker-build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Simple changelog generation
          echo "## Changes since last release" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --oneline --since="1 week ago" >> CHANGELOG.md

      - name: Create release package
        run: |
          # Create clean release package
          mkdir -p release/cerberus
          
          # Copy essential files
          cp -r lib/ release/cerberus/
          cp -r docs/ release/cerberus/
          cp -r tests/ release/cerberus/
          cp cerberus.sh release/cerberus/
          cp config-example.toml release/cerberus/
          cp config-tls-example.toml release/cerberus/
          cp README.md release/cerberus/
          cp LICENSE release/cerberus/
          
          # Clean up test artifacts
          find release/cerberus/tests -name "tmp" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # Create archive
          cd release
          tar -czf cerberus-latest.tar.gz cerberus/
          cd ..

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cerberus-release
          path: |
            release/cerberus-latest.tar.gz
            CHANGELOG.md
          retention-days: 30

      # - name: Create GitHub Release
      #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: v${{ github.run_number }}
      #     name: Release v${{ github.run_number }}
      #     body_path: CHANGELOG.md
      #     files: release/cerberus-latest.tar.gz
      #     draft: false
      #     prerelease: false

  # Notification
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [lint, test, stability, docker-build, security]
    if: always()
    steps:
      - name: Summarize results
        run: |
          echo "=== CI/CD Pipeline Results ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Stability: ${{ needs.stability.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          echo "Security: ${{ needs.security.result }}"
          
          if [[ "${{ needs.lint.result }}" == "success" && \
                "${{ needs.test.result }}" == "success" && \
                "${{ needs.stability.result }}" == "success" && \
                "${{ needs.docker-build.result }}" == "success" ]]; then
            echo "üéâ All checks passed!"
            exit 0
          else
            echo "‚ùå Some checks failed!"
            exit 1
          fi