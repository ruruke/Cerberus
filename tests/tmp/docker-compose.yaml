version: '3.8'

# Generated by Cerberus 2025-07-26 03:11:21 UTC
# Project: test-cerberus
# Configuration: test-config.toml

services:

  # Proxy Layer: proxy (nginx)
  proxy:
    image: nginx:stable-alpine
    container_name: proxy
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./proxy-configs/proxy:/etc/nginx:ro
      - ./built/logs:/var/log/nginx:rw
    networks:
      - front-net
      - back-net
    depends_on:
      - anubis
    environment:
      - PROXY_LAYER=0
      - UPSTREAM=http://anubis:8080
      - MAX_CONNECTIONS=1024
    labels:
      - "cerberus.service=proxy"
      - "cerberus.layer=0"
      - "cerberus.type=nginx"
    healthcheck:
      test: ["CMD", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Proxy Layer: proxy-2 (nginx)
  proxy-2:
    image: nginx:stable-alpine
    container_name: proxy-2
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./proxy-configs/proxy-2:/etc/nginx:ro
      - ./built/logs:/var/log/nginx:rw
    networks:
      - front-net
      - back-net
    depends_on:
      - 100.103.133.21
    environment:
      - PROXY_LAYER=1
      - UPSTREAM=http://100.103.133.21:3000
      - MAX_CONNECTIONS=1024
    labels:
      - "cerberus.service=proxy"
      - "cerberus.layer=1"
      - "cerberus.type=nginx"
    healthcheck:
      test: ["CMD", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
true

  # DDoS Protection Layer
  anubis:
    image: chaitin/anubis:latest
    container_name: anubis
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "9090:9090"
    volumes:
      - ./anubis/botPolicy.json:/app/botPolicy.json:ro
      - ./built/logs:/var/log/anubis:rw
    networks:
      - front-net
      - back-net
    environment:
      - BIND=:8080
      - DIFFICULTY=5
      - TARGET=http://proxy-2:80
      - METRICS_BIND=:9090
      - SERVE_ROBOTS_TXT=true
    labels:
      - "cerberus.service=ddos-protection"
      - "cerberus.layer=anubis"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - proxy-2

networks:
  front-net:
    driver: bridge
    name: cerberus-front
    ipam:
      config:
        - subnet: 172.20.0.0/16
  
  back-net:
    driver: bridge  
    name: cerberus-back
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  # Persistent data volumes
  postgres_data:
    driver: local
    name: cerberus-postgres
  
  redis_data:
    driver: local
    name: cerberus-redis
    
  # Log volumes
  nginx_logs:
    driver: local
    name: cerberus-logs
