# Generated by Cerberus
global
    log stdout local0
    maxconn 1024
    user haproxy
    group haproxy
    daemon
    
    # Security
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE+AESGCM:ECDHE+AES256:ECDHE+AES128:!PSK:!DHE:!RSA:!DSS:!aNull:!MD5
    ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    
    # Enable stats
    stats enable
    stats uri /haproxy?stats
    stats refresh 30s

# Frontend
frontend http_front
    bind *:80
    
    # Health check
    acl is_health path /health
    use_backend health_backend if is_health
    
    # Service routing
    acl is_test-service hdr(host) -i test.example.com
    use_backend test-service_backend if is_test-service
    default_backend no_match

# Health check backend
backend health_backend
    http-request return status 200 content-type text/plain string "healthy\n"

# Default backend
backend no_match
    http-request return status 404

# Backend for test-service
backend test-service_backend
    balance roundrobin
    option httpchk GET /health
    compression algo gzip
    compression type text/html text/plain text/css text/javascript application/json
    # WebSocket support
    option http-server-close
    timeout tunnel 1h
    server test-service1 backend:3000 check
