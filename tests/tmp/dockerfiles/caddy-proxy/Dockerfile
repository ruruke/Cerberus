# Generated by Cerberus
FROM caddy:alpine

# Install additional packages
RUN apk add --no-cache \
    bash \
    curl \
    && rm -rf /var/cache/apk/*

# Create caddy user if not exists
RUN id caddy || adduser -D -h /var/lib/caddy -s /bin/false caddy

# Copy Caddyfile
COPY Caddyfile /etc/caddy/Caddyfile

# Copy custom entrypoint if needed
COPY entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# Create log directory
RUN mkdir -p /var/log/caddy \
    && chown -R caddy:caddy /var/log/caddy

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:2019/health || exit 1

# Expose ports
EXPOSE 80 443 2019

# Run as caddy user
USER caddy

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
