# Dockerfile for {{proxy.name}} (Traefik)
# Generated by Cerberus Rust edition
# Project: {{project_name}}

FROM {{base_image}}

# Install additional tools (Traefik base image is distroless, so we create a multi-stage build)
FROM alpine:latest as tools
RUN apk add --no-cache \
    curl \
    wget \
    ca-certificates \
    tzdata

# Final stage
FROM {{base_image}}

# Copy tools from alpine
COPY --from=tools /usr/bin/curl /usr/bin/curl
COPY --from=tools /usr/bin/wget /usr/bin/wget
COPY --from=tools /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt

# Create directories
RUN mkdir -p {{log_path}} \
    && mkdir -p /etc/traefik \
    && mkdir -p /etc/traefik/dynamic

# Copy configuration
COPY {{config_file}} {{config_path}}

# Set permissions
RUN chmod 644 {{config_path}} \
    && chmod 755 /etc/traefik

# Expose ports
EXPOSE {{port}}
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:8080/ping || exit 1

# Labels
LABEL maintainer="Cerberus"
LABEL cerberus.component="proxy"
LABEL cerberus.proxy="{{proxy.name}}"
LABEL cerberus.proxy_type="traefik"
LABEL cerberus.project="{{project_name}}"

# Set up Traefik user (already exists in base image)
USER traefik

# Default command
ENTRYPOINT ["/traefik"]
CMD ["--configfile={{config_path}}"]