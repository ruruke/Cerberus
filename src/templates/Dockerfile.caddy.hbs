# Dockerfile for {{proxy.name}} (Caddy)
# Generated by Cerberus Rust edition
# Project: {{project_name}}

FROM {{base_image}}

# Install additional tools
RUN apk add --no-cache \
    curl \
    wget \
    ca-certificates \
    tzdata

# Create directories
RUN mkdir -p {{log_path}} \
    && mkdir -p /etc/caddy \
    && mkdir -p /var/lib/caddy \
    && mkdir -p /usr/share/caddy

# Copy configuration
COPY {{config_file}} {{config_path}}

# Set permissions
RUN chown -R caddy:caddy {{log_path}} \
    && chown -R caddy:caddy /etc/caddy \
    && chown -R caddy:caddy /var/lib/caddy \
    && chmod 644 {{config_path}}

# Expose port
EXPOSE {{port}}

# Health check
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD curl -f http://localhost:{{port}}/health || exit 1

# Labels
LABEL maintainer="Cerberus"
LABEL cerberus.component="proxy"
LABEL cerberus.proxy="{{proxy.name}}"
LABEL cerberus.proxy_type="caddy"
LABEL cerberus.project="{{project_name}}"

# Switch to non-root user
USER caddy

# Set working directory
WORKDIR /srv

# Default command
CMD ["caddy", "run", "--config", "{{config_path}}", "--adapter", "caddyfile"]